<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Area</title>
    <link rel="stylesheet" href="css/style.css"> <!-- Optional -->
</head>
<body>
    <h1>Test Area</h1>
    <p>This is the main test page.</p>
    <p>You should only see links below if you have permission.</p>

    <div id="links-section">
        <!-- Links will be added here by JS -->
    </div>

    <p><a href="index.html">Back to Login</a></p>
    <button id="logout-test" style="display: none;">Logout</button> <!-- Optional logout on this page -->

    <!-- Firebase SDKs (Needed on every page using Firebase) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore-compat.js"></script>

    <!-- Your Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/permissions.js"></script>

    <script>
        const linksSection = document.getElementById('links-section');
        const logoutButtonTest = document.getElementById('logout-test');

        auth.onAuthStateChanged(async (user) => {
            linksSection.innerHTML = ''; // Clear previous links
            logoutButtonTest.style.display = 'none';

            if (user) {
                logoutButtonTest.style.display = 'inline-block'; // Show logout if logged in
                console.log('User logged in on test.html:', user.uid);
                 try {
                    const permissions = await getUserPermissions(user.uid); // Use the function

                    if (!permissions) {
                        console.log("No permissions found, redirecting to index.");
                        window.location.href = 'index.html'; // Redirect if no permissions doc
                        return;
                    }

                    // Check specific permissions and add links
                    if (permissions.canAccessTest1) {
                        const link1 = document.createElement('a');
                        link1.href = 'test1.html';
                        link1.textContent = 'Go to Test Page 1';
                        linksSection.appendChild(link1);
                        linksSection.appendChild(document.createElement('br')); // Line break
                    }

                    if (permissions.canAccessTest2) {
                        const link2 = document.createElement('a');
                        link2.href = 'test2.html';
                        link2.textContent = 'Go to Test Page 2';
                        linksSection.appendChild(link2);
                        linksSection.appendChild(document.createElement('br')); // Line break
                    }

                    if (!permissions.canAccessTest1 && !permissions.canAccessTest2) {
                         // Logged in, but no specific access granted yet
                         const message = document.createElement('p');
                         message.textContent = "Your account is logged in, but access to specific test pages is pending verification.";
                         message.style.color = 'orange';
                         linksSection.appendChild(message);
                         console.log("User lacks specific permissions for test1/test2.");
                    }

                 } catch (error) {
                     console.error("Error checking permissions on test.html:", error);
                     linksSection.innerHTML = '<p style="color: red;">Error checking permissions. Cannot display links.</p>';
                     // Optionally redirect or show a more specific error
                 }

            } else {
                // Not logged in, redirect to index
                console.log("User not logged in, redirecting from test.html to index.html");
                window.location.href = 'index.html';
            }
        });

        // Optional: Logout functionality on this page
        logoutButtonTest.addEventListener('click', () => {
             auth.signOut().catch(err => console.error("Logout error", err));
             // onAuthStateChanged will trigger the redirect
        });
    </script>

</body>
</html>
